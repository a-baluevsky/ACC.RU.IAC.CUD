<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Получение ролей пользователей</title>

	<script data-main="/picketlink-oauth-provider-wwwserver/files/gfx/1.0.0/config_dev_local.js" 
			src="/picketlink-oauth-provider-wwwserver/files/gfx/1.0.0/lib/require-2.1.20.js"></script>
	<script src="/picketlink-oauth-provider-wwwserver/files/gfx/1.0.0/config_dev_local.js"></script>
	<script src="/picketlink-oauth-provider-wwwserver/files/gfx/1.0.0/lib/json2.js"></script>

</head>

<body onload="return window_onload()">
<h1 align="center">Получение ролей пользователей</h1>
	
<h2><strong>Сценарий 1</strong>. <code>/token/UserInfo</code>: Перечень кодов 
  в JWT или JSON</h2>
<p>Возвращается весь набор информации о&nbsp;пользователе, в т.ч. JWT-токен. </p>
<P>Ожидаемый результат вызова: </P>
<table width="800" border="1" cellspacing="0" cellpadding="0">
  <tr> 
    <td><strong>Формат</strong></td>
    <td width=400><strong>Значение</strong></td>
    <td><strong>Примечание</strong></td>
  </tr>
  <tr> 
    <td>JWT</td>
    <td width=400><p>eyJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJ1cm46ZWlzOkJsdWVTa3k6dGVzdDEiLCJpc3MiOiJ1cm46ZWlzOmN1ZCIsImp0aSI6ImJmYTQyNWVjNzM2M2QxN2I4N2E2NjI0Y2MwMGQ3NWJkIiwic3ViIjoiNDE4NSIsImV4cCI6MTQ2MTk0MjcxOCwiaWF0IjoxNDYxOTM5MTE4LCJPUkdfT0tPR1UiOiIiLCJVU0VSX0VNQUlMIjoiIiwiT1JHX0lOTiI6Ijc4MTUwMDA4NzAiLCJPUkdfQUREUkVTUyI6ItCn0LXRgNC90Y_RhdC-0LLRgdC60L7Qs9C-INGD0LsuLDU5MSIsIk9SR19OQU1FIjoi0KHQsNC90LrRgi3Qn9C10YLQtdGA0LHRg9GA0LPRgdC60L7QtSDQs9C-0YHRg9C00LDRgNGB0YLQstC10L3QvdC-0LUg0YPQvdC40YLQsNGA0L3QvtC1INC_0YDQtdC00L_RgNC40Y_RgtC40LUgwqvQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQs9GB0LrQuNC5INC40L3RhNC-0YDQvNCw0YbQuNC-0L3QvdC-LdCw0L3QsNC70LjRgtC40YfQtdGB0LrQuNC5INGG0LXQvdGC0YDCuyIsIk9SR19PR1JOIjoiMTAzNzg0MzA0MjkwNyIsIk9SR19PS1BPIjoiIiwiT1JHX1BIT05FIjoiMjEyODUwNiIsIkRFUF9BRERSRVNTIjoiIiwiT1JHX0NPREVfSU9HViI6IjAyMDAwMDAwNzgiLCJVU0VSX0xPR0lOIjoiYmFsdWV2c2t5IiwiVVNFUl9VSUQiOiI0MTg1IiwiVVNFUl9QT1NJVElPTiI6ItC_0YDQvtCz0YDQsNC80LzQuNGB0YIiLCJPUkdfU0lURSI6IiIsIlVTRVJfUEhPTkUiOiIiLCJPUkdfS1BQIjoiNzg0MjAxMDAxIiwiVVNFUl9GSU8iOiLQkdCw0LvRg9C10LLRgdC60LjQuSDQkNC90LTRgNC10Lkg0JLQu9Cw0LTQuNC80LjRgNC-0LLQuNGHIiwiVVNFUl9TTklMUyI6IiIsIkRFUF9OQU1FIjoi0L7RgtC00LXQuyAyMzQiLCJPUkdfRU1BSUwiOiJ3d3cuaWFjLnJ1IiwidXNlclJvbGVzIjoidXJuOnJvbGU6Qmx1ZVNreTp0ZXN0MSx1cm46cm9sZTpCbHVlU2t5OnRlc3QyIiwiT1JHX0NPREVfT0tBVE8iOiI0MDI5ODU2NTAwMCIsImFtciI6IlBXRCJ9.ABCDEFGHIJKLM</p></td>
    <td><p>userRoles содержит только коды ролей;</p>
      <p>Результат расшифровки с помощью JWT-debugger (https://jwt.io/): </p>
      <p>{ "aud": "urn:eis:BlueSky:test1", "iss": 
      "urn:eis:cud", "jti": "bfa425ec7363d17b87a6624cc00d75bd", "sub": "4185", 
      "exp": 1461942718, "iat": 1461939118, "ORG_OKOGU": "", "USER_EMAIL": "", 
      "ORG_INN": "7815000870", "ORG_ADDRESS": "Черняховского ул.,591", 
      "ORG_NAME": "Санкт-Петербургское государственное унитарное предприятие 
      «Санкт-Петербургский информационно-аналитический центр»", "ORG_OGRN": 
      "1037843042907", "ORG_OKPO": "", "ORG_PHONE": "2128506", "DEP_ADDRESS": 
      "", "ORG_CODE_IOGV": "0200000078", "USER_LOGIN": "baluevsky", "USER_UID": 
      "4185", "USER_POSITION": "программист", "ORG_SITE": "", "USER_PHONE": "", 
      "ORG_KPP": "784201001", "USER_FIO": "Балуевский Андрей Владимирович", 
      "USER_SNILS": "", "DEP_NAME": "отдел 234", "ORG_EMAIL": "www.iac.ru", </p>
      <p><STRONG>"userRoles": 
      "urn:role:BlueSky:test1,urn:role:BlueSky:test2"</STRONG>, 
      "ORG_CODE_OKATO": "40298565000", "amr": "PWD"
        } </p></td>
  </tr>
  <tr> 
    <td>JSON</td>
    <td width=400><p>token info: {"token_info_type":"json","token_info":{"ORG_OKOGU":"","USER_EMAIL":"","ORG_INN":"7815000870",</p>
      <p>"ORG_ADDRESS":"Черняховского ул.,591","ORG_SITE":"","ORG_NAME":"Санкт-Петербургское 
        государственное унитарное предприятие «Санкт-Петербургский информационно-аналитический 
        центр»",</p>
      <p>"USER_PHONE":"","ORG_KPP":"784201001","ORG_OKPO":"","ORG_OGRN":"1037843042907","ORG_PHONE":"2128506","USER_FIO":"Балуевский 
        Андрей Владимирович","DEP_ADDRESS":"",</p>
      <p>"ORG_CODE_IOGV":"0200000078","USER_LOGIN":"baluevsky","USER_SNILS":"","DEP_NAME":"отдел 
      234","ORG_EMAIL":"www.iac.ru",<STRONG>"userRoles":"urn:role:BlueSky:test1,urn:role:BlueSky:test2"</STRONG>,"ORG_CODE_OKATO":"40298565000","USER_UID":"4185","USER_POSITION":"программист"}}</p></td>
    <td>userRoles содержит только коды ролей</td>
  </tr>
</table>
<p> </p>
<p>
</p>	
<h2><strong>Сценарий 2</strong>. <code>/token/UserInfo/Roles</code>: Перечень 
  кодов ролей в формате JSON</h2>	
<p>Соответствует REST-подходу. Ожидаемый результат вызова: ["urn:role:BlueSky:test1","urn:role:BlueSky:test2"]</p>	
<p>  
      &nbsp;</p>
<p></p>		
<h2><strong>Сценарий 3</strong>. <code>/token/UserInfo/RolesInfo</code>: Получение 
  сведений о роли в формате JSON</h2>		
<p>Наиболее удобный способ для использования приложением. С 
помощью параметров role_code и role_info можно указывать, какие сведения нужно получить.</p>		
<p>По умолчанию возвращаются&nbsp;атрибуты code, name&nbsp;всех ролей.</p>		
<p>  
       &nbsp;</p>		
<p>  Ожидаемый результат вызова (для полного 
набора атрибутов ролей&nbsp;name, description, creator_id, date_created, modificator_id, date_modified):</p>		
<p>{<STRONG><U>"urn:role:BlueSky:test1"</U></STRONG>:{"date_modified":null,"description":null,"modificator_id":null,"name":"Tester 
#1","date_created":1461837930000,"creator_id":4185},<BR>&nbsp;<STRONG><U> 
"urn:role:BlueSky:test2</U>"</STRONG>:{"date_modified":null,"description":null,"modificator_id":null,"name":"Tester 
#2","date_created":1461837982000,"creator_id":4185}}</p>		
<p>  
       &nbsp;</p>
<p></p>	
  
	
<h2 align="center">Тестовый стенд</h2>
<p>OAuth Provider:&nbsp;
	<select id="cboAuthProviderAddr" name="select" style="WIDTH: 160px" onchange="return cboAuthProviderAddr_onchange()">
	<option value="paaa1.test.toris.vpn">paaa1.test.toris.vpn</option>
	<option value="paaa2.test.toris.vpn">paaa2.test.toris.vpn</option>
	<option value="cuddevelop1:8080" selected>cuddevelop1:8080</option>
	</select>
	<span id="spnAuthProviderAddrURL">Select OAuth Provider Address!</span>
	
</p>	
<P>
<TABLE cellSpacing=1 cellPadding=1 width="75%" border=0 align=center>
  
  <TR>
    <TD>Access Token:&nbsp;</TD>
    <TD><INPUT id=txtAccessToken size=45 name=txtAccessToken></TD></TR>
  <TR>
    <TD>
      role_code:</TD>
    <TD><INPUT id=txtRoleId size=45 name=txtRoleId></TD></TR>
  <TR>
    <TD>
      role_info:</TD>
    <TD><INPUT id=txtRoleInfo size=45 name=txtRoleInfo value="name, description, creator_id, date_created, modificator_id, date_modified" 
     ></TD></TR></TABLE></P>	
	<P>&nbsp;&nbsp;&nbsp;</P>
	<DIV id=TesterPanel></DIV>

	<script id="jsTestSetGFX" language="javascript">
		var userLogin = 'baluevsky', userPassword = userLogin;	
		var oapr;
		var testAppInfo, clientApp, user;
		
		function callback(err, res) {
			if(err) 
				lgrGFXTest.writeLine('ERROR! '+JSON.stringify(err));
			else
				lgrGFXTest.writeLine('RESULT: '+JSON.stringify(res));
		}
		
		function test_getClientAppAccessToken() {
			var getGetAccTknFromUserCredsCb =  _.partial(async.genericErrResCallback, function(data) {
				//debugger;
				var access_token = txtAccessToken.value = data.access_token;
				lgrGFXTest.writeLine('ClientApp got access_token: '+access_token+'  for user creds: '+user.Login);
				return access_token;
			}, callback);
			clientApp.getAccessTokenFromUserCredentials({user: user, password: userPassword}, getGetAccTknFromUserCredsCb);
		}
	
		function test_UseCase1_RAW_JSON() {
			test_UseCase1_RAW_JWT('JSON');
		}
		
		function test_UseCase1_RAW_JWT(tknInfoType) {
			if(!txtAccessToken.value) {
				alert("Access Token must be inited first! Try again later.");
				test_getClientAppAccessToken();
				return;
			}
			var user_acc_token = txtAccessToken.value.replace(/\s*/g, '');
			
			tknInfoType = tknInfoType || 'jwt';
			oapr.TokenUserAccessInfo(function (err, result) {
				if(err)
					lgrGFXTest.writeLine('oapr: Error: '+err);
				else {		
					var tokenInfo=result.data;
					lgrGFXTest.writeLine('token info: ' + JSON.stringify(tokenInfo));
				}
			}, user_acc_token, 'Bearer', tknInfoType );				
				
		}
		
		function test_UseCase2_GetClientAppUserRoles_RAW() {
			if(!txtAccessToken.value) {
				alert("Access Token must be inited first! Try again later.");
				test_getClientAppAccessToken();
				return;
			}
			var user_acc_token = txtAccessToken.value.replace(/\s*/g, '');
			
			oapr.GetClientAppUserRoles(function (err, result) {
				if(err)
					lgrGFXTest.writeLine('oapr: Error: '+err);
				else {		
					var userRoles=result.data;
					lgrGFXTest.writeLine('GetClientAppUserRoles: ' + JSON.stringify(userRoles));
				}
			}, user_acc_token, 'Bearer');						
		}
		
		function test_UseCase3_GetClientAppUserRolesInfo() {
			if(!txtAccessToken.value) {
				alert("Access Token must be inited first! Try again later.");
				test_getClientAppAccessToken();
				return;
			}
			//debugger;
			var getClientAppUserRolesCb = _.partial(async.genericErrResCallback, function(userRoles) {
				lgrGFXTest.writeLine('Roles for '+user.Login+' in '+clientApp.client_id);
				_.each(userRoles, function (role, name) {
					//debugger;
					var sReport = name+': ';
					for(var k in role)
						sReport+= k+': '+role[k]+'   ';
					//lgrGFXTest.writeLine(name+': '+role.code+': '+role.name);
					lgrGFXTest.writeLine(sReport);
				});
				return userRoles;
			}, callback);
			
			var role_code = null;
			var role_info = null;
			if(txtRoleId.value)
				role_code = txtRoleId.value;
			if(txtRoleInfo.value)
				role_info = txtRoleInfo.value.replace(/\s+/g, '').split(',')
			
			clientApp.getClientAppUserRolesInfo({user: user, role_code: role_code, role_info: role_info}, getClientAppUserRolesCb);
		};
		
	</script>
	
	<SCRIPT ID=testerGFX LANGUAGE=javascript>
		var lgrGFXTest, testerGFX;
		function window_onload() {
			cboAuthProviderAddr_onchange();
			requirejs([ 'underscore_plus', 'async', 'LoggerFX', 'TesterFX',
				'GaliaJSFX_OAuthProviderREST', 'GaliaJSFX_ClientApp', 'GaliaJSFX_ClientAppUser'
			], //
			function(_, async, lfx, tfx,
				_oapr, _ClientApp, _User) {
				if(!window._) window._ = _;				
				if(!window.async) window.async = async;
				
				tfx.createrTesterPanel(TesterPanel);
				
				lgrGFXTest = lfx.newListLogger(lstTestOutputGFX);
				testerGFX = tfx.newTester({testSetId: "jsTestSetGFX"});
				testerGFX.outputTestList(lstTestsGFX);
				
				oapr		= _oapr.new_OAuthProviderREST(L_OAUTH_PROVIDER_ROOT, lgrGFXTest);
				
				testAppInfo = _ClientApp.RegClientApps.CTest2ClientApp;			
				clientApp	= _ClientApp.new_ClientApp(testAppInfo, L_OAUTH_PROVIDER_ROOT)
				user		= _User.new_ClientAppUser(userLogin, L_OAUTH_PROVIDER_ROOT);
				
				if(_.isIEOlderThan(7))
					lgrGFXTest.writeLine('IE 6');
					
				//test_getClientAppAccessToken();
					
			});
		}
		function cboAuthProviderAddr_onchange() {
			L_OAUTH_PROVIDER_ADDR = cboAuthProviderAddr.value; // 'cuddevelop1:8080'; 'paaa1.test.toris.vpn'; // ; //  'paaa1.test.toris.vpn' //
			L_OAUTH_PROVIDER_ROOT = 'http://'+L_OAUTH_PROVIDER_ADDR+"/picketlink-oauth-provider-wwwserver";	
			spnAuthProviderAddrURL.innerText = L_OAUTH_PROVIDER_ROOT;
		}
	</SCRIPT>
	
</body>
</html>
