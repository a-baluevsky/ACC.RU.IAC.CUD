<?xml version='1.0' encoding='windows-1251' ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:c="http://java.sun.com/jstl/core">
	<script type="text/javascript">
	//<![CDATA[     
		//debugger;
		$include("BAVIAC.TextInput", "#{request.contextPath}/jscss/TextInput.js", "{5890CB2D-138F-45F2-B6A8-2E485AF83F43}");
		//var g_DateInputFrom, g_DateInputTo;
	//]]>
	</script>

	<h3 class="ui-widget-header">Аудит действий пользователя</h3>

	<div class="ui-widget-header" style="background: #E6E6E6;">
		<a4j:outputPanel id="outCenterCenterHeader">
			<table>
				<tr>
					<td valign="middle">
						<!--a4j:commandButton style="width:100px;"
            value="Архивирование" 
            onclick="#{rich:component('CTClearDate')}.show();return false; " 
            styleClass="but_class"
            rendered="#{authenticator.accessPerm('urn_part_audit_func','2')}"/-->

						<!--a4j:commandButton style="width:60px;margin-left:10px;"
            value="Отчёт" 
            onclick="#{rich:component('CBReport')}.show();return false; " 
            styleClass="but_class"/> 
          
         <s:link view="/context_pro/mc/audit/func/reportCubeWord.xhtml"
                action="#{aFuncManager.forViewWord('user_group_actions')}"
                target="#" style="margin-left:10px;"
                styleClass="but_link_class" >
              <h:outputText value="Обобщённый отчёт" escape="false"/> 
              <f:param name="remoteAudit" value="protBeanWord"/>
              <f:param name="modelType" value="#{modelType}"/>
           </s:link-->

					</td>
					<td height="25px;"><h:outputText value="&amp;nbsp;"
							escape="false" /></td>
				</tr>
			</table>
		</a4j:outputPanel>
	</div>

	<div class="ui-layout-content">
		<a4j:outputPanel id="outCenterCenter">

			<s:div rendered="#{aFuncManager.evaluteForList}">

				<a4j:queue ignoreDupResponce="true" />

				<rich:dataTable id="audit_dt" style="width:100%" var="it"
					value="#{aFuncDataModel}" rows="#{profile.rowsCountAFunc}"
					reRender="dt_dscr"
					onRowClick="invokeRemoteAuditBean(
        '#{it.baseId}',
        'rowSelectFact',
        '#{param['auditListCount'] != null ? param['auditListCount'] : aFuncDataModel.rowCount}');">

					<rich:columns value="#{aFuncManager.auditItemsListSelect}"
						var="field" index="index" id="column#{index}"
						styleClass="#{it.baseId==param['sessionId'] ? 'audit_record_active' : ''}"
						style="#{it.selected=='true' ? 'background-color: yellow;' : ''} cursor:pointer;">
						<f:facet name="header">

							<h:panelGroup>
								<h:outputText value="#{field.itemLabel}" />
								<a4j:commandLink
									onclick="invokeSort(
		                 '#{param['sessionId']}',
	                     'filterFieldFact',
	                     '#{field.itemSortField}'); return false;">
									<h:graphicImage
										url="/img/icons/sort_#{aFuncStateHolder.sortOrders[field.itemSortField]}.gif"
										styleClass="img-in-link" height="14" width="14" />
								</a4j:commandLink>
								<br />
								<c:choose>
									<c:when test="#{field.itemField=='isName'}">
										<h:selectOneMenu
											value="#{aFuncStateHolder.columnFilterValues[field.itemFiltField]}"
											id="som#{index}" style="width:100px;"
											onchange="invokeMyStart();">
											<f:selectItem itemLabel="Все" itemValue="#-1#" />
											<s:selectItems value="#{armManager.listArm}" var="n"
												label="#{n.name}" itemValue="#{n.idArm}" />
										</h:selectOneMenu>
									</c:when>
									<c:when test="#{field.itemFiltField=='act_dat_value'}">
										<rich:calendar id="dateInputActDatFrom"
											locale="RU"
											showWeeksBar="false"
											value="#{aFuncStateHolder.columnFilterValues['act_dat_value']}"
											datePattern="dd.MM.yyyy"
											immediate="true"
											onchanged="invokeMyStart()"
											enableManualInput="true"
											inputSize="6" />
										<rich:calendar id="dateInputActDatTo"
											locale="RU"
											showWeeksBar="false"
											value="#{aFuncStateHolder.columnFilterValues['act_dat_value2']}"
											datePattern="dd.MM.yyyy"
											immediate="true"
											onchanged="invokeMyStart()"	enableManualInput="true"									
											inputSize="6"/>
										<SCRIPT type="text/javascript">
										//<![CDATA[
										function calendarKeyPress(evt) {
											  evt=evt || event || window.event;
											  var kc=evt.keyCode;
											  switch(kc) {
											  case 8: case 46: case 13: // DELETE & ENTER 
													invokeMyStart(); 
													break;
											  }         
										}										
										function initDateInput(richCalId) {
											if($(richCalId))
												with($load(BAVIAC.TextInput)) {
													var cmpDateInput=$(richCalId).component;
													var txtDateInput=$(cmpDateInput.INPUT_DATE_ID);
													txtDateInput.onkeydown=calendarKeyPress;
													var g_DateInput=new DateTextInput(txtDateInput);
													cmpDateInput.params.labels.today="Сегодня";	
												}
											else {
												setTimeout(Functional(initDateInput, richCalId), 1000 );
											}
										}											
									   initDateInput("fAuditList:audit_dt:dateInputActDatFrom");
									   initDateInput("fAuditList:audit_dt:dateInputActDatTo");
									  //]]>
									 </SCRIPT> 
									</c:when>
									<c:otherwise>
										<!--<h:outputText value="#{field.itemFiltField}" />-->
										<h:inputText
											value="#{aFuncStateHolder.columnFilterValues[field.itemFiltField]}"
											immediate="true" id="iaf#{index}"
											onkeypress="if(event.keyCode==13){invokeMyStart();}" />
									</c:otherwise>									
									</c:choose>								
							</h:panelGroup>
						</f:facet>
						<!--c:choose> 
             <c:when test="#{field.itemField=='dateAction'}" > 
               <h:outputText value="#{it[field.itemField]}">
                  <s:convertDateTime pattern="dd.MM.yy HH:mm:ss"/>
               </h:outputText>
             </c:when> 
             <c:otherwise-->
						<h:outputText value="#{it[field.itemField]}" />
						<!--/c:otherwise> 
          </c:choose-->

					</rich:columns>

					<f:param name="#{param['sessionId']!=null ? 'sessionId' : 'xxx1'}"
						value="#{param['sessionId']}" />
					<f:param name="remoteAudit" value="1" />
				</rich:dataTable>
				<a4j:jsFunction name="invokeMyStart"
					reRender="outCenterCenterFooter,outCenterCenter,outCenterCenterQueryStatText"
					oncomplete="setCaretToEnd(event);">
					<f:param name="#{param['sessionId']!=null ? 'sessionId' : 'xxx1'}"
						value="#{param['sessionId']}" />
					<f:param name="remoteAudit" value="filterFieldFact" />
					<f:param name="idRai" value="#{param['idRai']}" />
				</a4j:jsFunction>
			</s:div>
		</a4j:outputPanel>
	</div>

	<div class="ui-widget-footer" style="background: #E6E6E6;">
		<a4j:outputPanel id="outCenterCenterFooter">

			<table>
				<tr>
					<td><s:div rendered="#{aFuncManager.evaluteForListFooter}">

							<table style="width: 95%" border="0">
								<tr>
									<td width="40px;"><h:outputText value="Строк:" /></td>
									<td width="50px;"><rich:inputNumberSpinner
											value="#{profile.rowsCountAFunc}" inputSize="1" id="rowCId"
											minValue="10" step="10" enableManualInput="false"
											oninputkeypress="return false;" /></td>
									<td width="40px;"><a4j:commandLink
											reRender="outCenterCenter, outCenterCenterFooterDscr,outCenterCenterQueryStatText"
											ajaxSingle="true" process="rowCId">
											<h:graphicImage url="/img/icons/Da.gif"
												styleClass="img-in-link" height="14" width="14" />
											<f:param
												name="#{param['sessionId']!=null ? 'sessionId' : 'xxx1'}"
												value="#{param['sessionId']}" />
											<f:param name="remoteAudit" value="rowCountFact" />
										</a4j:commandLink></td>
									<td><a4j:outputPanel id="outCenterCenterFooterDscr">
											<rich:datascroller align="center" for="audit_dt" maxPages="5"
												stepControls="hide" id="dt_dscr" immediate="true"
												renderIfSinglePage="false" reRender="outCenterCenter,outCenterCenterQueryStatText"
												ajaxSingle="true" style="padding-right:30px;">
												<f:param name="auditListCount"
													value="#{aFuncDataModel.rowCount2}" />
												<f:param
													name="#{param['sessionId']!=null ? 'sessionId' : 'xxx1'}"
													value="#{param['sessionId']}" />
												<f:param name="remoteAudit" value="dScrollFact" />
											</rich:datascroller>
										</a4j:outputPanel></td>
									<!--td width="80px;">
              <a4j:commandLink 
               value="Столбцы"
               onclick="invokeSelectColumns(
                   '1',
                   '#{param['sessionId']}',
                   '#{param['entryid']}',
                   'onSelColFact',
                   '#{param['idRai']}',
                   '#{param['auditListCount'] != null ? param['auditListCount'] : auditDataModel.rowCount}');return false;">
               </a4j:commandLink>
              </td-->
									<td><s:div rendered="#{param['sessionId']!=null}">
											<a4j:commandButton style="width:60px;" ajaxSingle="true"
												reRender="outCenterCenter, outCenterCenterFooter,outCenterCenterQueryStatText"
												value="#{aFuncBean.selected ? 'Очистить' : 'Отметить'}"
												action="#{aFuncManager.selectRecord}" styleClass="but_class">
												<f:param name="sessionId" value="#{param['sessionId']}" />
												<f:param name="remoteAudit" value="clSelOneFact" />
												<f:param name="auditListCount"
													value="#{param['auditListCount'] != null ? param['auditListCount'] : aFuncDataModel.rowCount}" />
											</a4j:commandButton>
										</s:div></td>
										<!-- 17.02.15: AB: MANTIS-4954  -->
										<td width="260px" align="right"><a4j:outputPanel id="outCenterCenterQueryStatText">
											<h:outputText value="#{aFuncManager.queryStatText}" />
											<!-- , #{param['auditListCount']}  -->
											</a4j:outputPanel>
										</td>										
								</tr>
							</table>

						</s:div></td>
					<td height="25px;"><h:outputText value="&amp;nbsp;"
							escape="false" /></td>
				</tr>
			</table>
		</a4j:outputPanel>
	</div>
	<SCRIPT type="text/javascript">
 //<![CDATA[
    jQuery(document).ready(
	   function () {
		   invokeRemoteAudit();
		   with($load(BAVIAC.TextInput)) { fixAppList("fAuditList:audit_dt:som2");  }
		}
	);
		   
    function setCaretToEnd(e) {
		with($load(BAVIAC.TextInput)) { fixAppList("fAuditList:audit_dt:som2");  }
		
        var id = (e.target ? e.target : e.srcElement).id;
        if(id.indexOf("dateInput")!=-1) { 
            // AB: don't touch TextDate controls to avoid their misbehavior 
            return;
        }
        var control = document.getElementById(id);
      
        if (control.createTextRange) {
            var range = control.createTextRange();
            range.collapse(false);
            range.select();
        }else if (control.setSelectionRange) {al
            control.focus();
            var length = control.value.length;
            control.setSelectionRange(length, length);
        }
        control.selectionStart = control.selectionEnd = control.value.length;
    } 
	
  //]]>
 </SCRIPT>
</ui:composition>